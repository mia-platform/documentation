---
id: configure-gitlab-runners
title: Deploy with GitLab Runners
sidebar_label: Deploy with GitLab Runners
---

Mia-Platform Console can be configured to deploy your Project using GitLab Runners.

To deploy your projects using Azure Pipelines, you must add the Azure DevOps Provider on the Company Overview page, select the CI/CD Tool option, and then follow the [standard Provider configuration](/console/company-configuration/providers/configure-provider.mdx).

![Provider](./img/gitlab-runners-provider.png)

## Workflow

In your Git working directory, create a new file called `.gitlab-ci.yml`.

The file should be structured as follows:

- a section to setup the variables used by `mlp` to locate the various configuration files generated by the Console;
- a section to setup the secrets variables used by `mlp` to authenticate to the Cluster - this section should be replicated for every runtime environment;
- a section to launch `mlp` to apply the manifests into Kubernetes.

:::info
It is possible to add more sections to the pipeline to check optional stages, like security and compliancy checks.
:::

Let's dive into these sections.

### Repository Variables Setup

In order to make `mlp` aware of the configuration files generated by the Mia-Platform Console, the following variables should be declared in the `variables` field of the pipeline:

```yaml
variables:
  ENVIRONMENT_VARIABLES_PREFIX: MIA_
  BASE_PATH: "${CI_PROJECT_DIR}/configuration"
  OVERLAY_PATH: "${CI_PROJECT_DIR}/overlays/${ENVIRONMENT_TO_DEPLOY}"
  DESTINATION_PATH: "${CI_PROJECT_DIR}/interpolated-files"
  GENERATE_FILE: "${CI_PROJECT_DIR}/mlp.yaml"
  VARIABLES_FILE: "${CI_PROJECT_DIR}/overlays/${ENVIRONMENT_TO_DEPLOY}/variables.env"
```

Where:

- `ENVIRONMENT_VARIABLES_PREFIX`: this variable is used as the **Global prefix** for the variables managed in the Project section of the Console, check [here](../../../console/project-configuration/manage-environment-variables/manage-environment-variables-with-gitlab.md#how-to-differentiate-your-variable-from-one-environment-to-another) for more details;
- `BASE_PATH`: this variables points to the folder in the repository where the Console is saving the worload's manifests;
- `OVERLAY_PATH`: this variables points to the overlays folder relative to the selected deploy environment. This folder contains the Kustomize configuration files (check [here](../../../console/project-configuration/kustomize-your-configurations/manage-a-kustomize-project.md) for details);
- `DESTINATION_PATH`: this variable represents the folder where `mlp` will store the manifests after the [`interpolate`](../../../runtime_suite_tools/mlp/30_interpolate.md) process;
- `GENERATE_FILE`: this variable points to the `mlp.yaml` file that contains the configuration of the Kubernetes secrets that will be [generated](../../../runtime_suite_tools/mlp/40_generate.md) by `mlp`;
- `VARIABLES_FILE`: this variable points to the `variables.env` file for the selected deploy environment. This file contains the configuration of the Public Variables created via Mia-Platform Console (check [here](../../api-console/api-design/public_variables.md) for more details);

:::info
The `CI_PROJECT_DIR` placeholder is automatically managed by GitLab - it will be replaced with the full path of the configuration repo when the pipeline is triggered.
:::

### Infrastructure Secrets Setup

In order to make `mlp` able to connect to the Kubernetes Cluster and been able to switch properly those configuration for the different runtime environments available for the Mia-Platform Console's Project, the following variables should be declared:

```yaml
variables:
  DEPLOY_TYPE: deploy_all
  FORCE_DEPLOY_WHEN_NO_SEMVER: "false"
  KUBE_URL: "${KUBE_NOPROD_URL}"
  KUBE_TOKEN: "${KUBE_NOPROD_TOKEN}"
  KUBE_CA_PEM: "${KUBE_NOPROD_CA_PEM}"
  ENVIRONMENT_PREFIX: <<ENV_ID>>_
```

Where:

- `DEPLOY_TYPE`: is used by `mlp` to perform a Smart of Full Deploy - this feature is available from the Mia-Platform Console, [here](../overview.md#smart-deploy) the details;
- `FORCE_DEPLOY_WHEN_NO_SEMVER`: is used by `mlp` to force deployment wuthout semver - this toggle is available in the Mia-Platform Console;
- `KUBE_URL`: it's the URL to the API Server of the Kubernetes cluster target of the deploy;
- `KUBE_TOKEN`: it's the JWT Token used by `mlp` to authenticate into the Kubernetes Cluster - it should be relative to a Service Account created in the Cluster;
- `KUBE_CA_PEM`: it's the certificate used by `mlp` to authenticate into the Kubernetes Cluster - it should be relative to the same Service Account seen above;
- `ENVIRONMENT_PREFIX`: it's the differentiate prefix used to filter the secret variables configured in the Project section of the Console, check [this](../../../console/project-configuration/manage-environment-variables/manage-environment-variables-with-gitlab.md#how-to-differentiate-your-variable-from-one-environment-to-another) page for more details;
